<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ecopipeline.lbnl &mdash; Ecotope Datapipeline (Ecopipeline) 0.0.13 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Ecotope Datapipeline (Ecopipeline)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ecotope Datapipeline (Ecopipeline)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ecopipeline.lbnl</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ecopipeline.lbnl</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">ecopipeline.config</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="kn">from</span> <span class="nn">ecopipeline.config</span> <span class="kn">import</span> <span class="n">_input_directory</span><span class="p">,</span> <span class="n">_output_directory</span>
<span class="kn">import</span> <span class="nn">os</span>

<div class="viewcode-block" id="site_specific"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.site_specific">[docs]</a><span class="k">def</span> <span class="nf">site_specific</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does Site Specific Calculations for LBNL. The site name is searched using RegEx</span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): dataframe of data </span>
<span class="sd">        site (str): site name as a string</span>
<span class="sd">    Output: </span>
<span class="sd">        pd.DataFrame: modified dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Bob&#39;s site notes says add 55 Pa to the Pressure</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;MO2_&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pressure_staticP&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">55</span>

    <span class="c1"># Calculate Power vars</span>
    <span class="c1"># All MO &amp; IL sites.</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(AZ2_01|AZ2_02|MO2_|IL2_|NW2_01)&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="c1"># Calculation goes negative to -0.001 sometimes.</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_fan1&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_fan1&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_compressor1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_fan1&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_compressor1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_compressor1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_system1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_AH1&quot;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(AZ2_03)&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_compressor1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_fan1&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_AH1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_system1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(AZ2_04|AZ2_05)&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_system1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_AH1&quot;</span><span class="p">]</span>

    <span class="c1"># Extra site specific calculations can be added with an extra elif statement and RegEx</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="lbnl_sat_calculations"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.lbnl_sat_calculations">[docs]</a><span class="k">def</span> <span class="nf">lbnl_sat_calculations</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;.*Temp_SAT.*&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_SATAvg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="lbnl_pressure_conversions"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.lbnl_pressure_conversions">[docs]</a><span class="k">def</span> <span class="nf">lbnl_pressure_conversions</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Pressure_staticInWC&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;Pressure_staticPa&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">inWC_2_Pa</span> <span class="o">=</span> <span class="mf">248.84</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pressure_staticP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pressure_staticPa&quot;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">(</span><span class="n">inWC_2_Pa</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pressure_staticInWC&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="lbnl_temperature_conversions"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.lbnl_temperature_conversions">[docs]</a><span class="k">def</span> <span class="nf">lbnl_temperature_conversions</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;Temp_LL_C&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_LL_F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_LL_C&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">32</span>

    <span class="k">if</span> <span class="s2">&quot;Temp_SL_C&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_SL_F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_SL_C&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">32</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="condensate_calculations"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.condensate_calculations">[docs]</a><span class="k">def</span> <span class="nf">condensate_calculations</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">site_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates condensate values for the given dataframe</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): dataframe to be modified</span>
<span class="sd">        site (str): name of site</span>
<span class="sd">        site_info (pd.Series): Series of site info</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: modified dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oz_2_m3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">33810</span>  <span class="c1"># [m3/oz]</span>
    <span class="n">water_density</span> <span class="o">=</span> <span class="mi">997</span>  <span class="c1"># [kg/mÂ³]</span>
    <span class="n">water_latent_vaporization</span> <span class="o">=</span> <span class="mf">2264.705</span>  <span class="c1"># [kJ/kg]</span>

    <span class="c1"># Condensate calculations</span>
    <span class="k">if</span> <span class="s2">&quot;Condensate_ontime&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">cycle_length</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="s2">&quot;condensate_cycle_length&quot;</span><span class="p">]</span>
        <span class="n">oz_per_tip</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="s2">&quot;condensate_oz_per_tip&quot;</span><span class="p">]</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Condensate_oz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Condensate_ontime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">cycle_length</span> <span class="o">*</span> <span class="n">oz_per_tip</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;Condensate_pulse_avg&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">oz_per_tip</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="s2">&quot;condensate_oz_per_tip&quot;</span><span class="p">]</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Condensate_oz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Condensate_pulse_avg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">oz_per_tip</span><span class="p">)</span>

    <span class="c1"># Get instantaneous energy from condensation</span>
    <span class="k">if</span> <span class="s2">&quot;Condensate_oz&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Condensate_kJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Condensate_oz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">oz_2_m3</span> <span class="o">*</span> <span class="n">water_density</span> <span class="o">*</span> <span class="n">water_latent_vaporization</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Condensate_oz&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="gas_valve_diff"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.gas_valve_diff">[docs]</a><span class="k">def</span> <span class="nf">gas_valve_diff</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in the site dataframe and the site name. If the site has gas </span>
<span class="sd">    heating, take the lagged difference to get per minute values. </span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): Dataframe for site</span>
<span class="sd">        site (str): site name as string</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: modified Pandas Dataframe </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_dir</span> <span class="o">=</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">)</span>
    <span class="n">site_info_path</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">+</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;site_info&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">site_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">site_info_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File Not Found: &quot;</span><span class="p">,</span> <span class="n">site_info_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">specific_site_info</span> <span class="o">=</span> <span class="n">site_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">site_info</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specific_site_info</span><span class="p">[</span><span class="s2">&quot;heating_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;gasvalve&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="s2">&quot;gasvalve_lowstage&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;gasvalve_highstage&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve_lowstage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve_lowstage&quot;</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve_lowstage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve_highstage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve_highstage&quot;</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gasvalve_highstage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1"># .apply helper function for get_refrig_charge, calculates w/subcooling method when metering = txv</span>
<span class="k">def</span> <span class="nf">_subcooling</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">lr_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a Pandas series and a linear regression model, calculates </span>
<span class="sd">    Refrig_charge for the Pandas series with that model, then inserts it into the series and returns it. </span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        row (pd.Series): Pandas series</span>
<span class="sd">        lr_model (sklearn.linear_model.Fit): Linear regression model</span>
<span class="sd">    Returns: </span>
<span class="sd">        row (pd.Series): Pandas series (Refrig_charge added!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># linear regression model gets passed in, we use it to calculate sat_temp_f, then take difference</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Pressure_SL_psi&quot;</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">lr_model</span><span class="o">.</span><span class="n">coef_</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">lr_model</span><span class="o">.</span><span class="n">intercept_</span>
    <span class="n">sat_temp_f</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">b</span>
    <span class="c1">#convert old temp to F</span>
    <span class="n">temp_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Temp_LL_C&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="mi">32</span>

    <span class="n">r_charge</span> <span class="o">=</span> <span class="n">sat_temp_f</span> <span class="o">-</span> <span class="n">temp_f</span>
    <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Refrig_charge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_charge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">row</span>

<span class="c1"># .apply helper function for get_refrig_charge, calculates w/superheat method when metering = orifice</span>
<span class="k">def</span> <span class="nf">_superheat</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">superchart</span><span class="p">,</span> <span class="n">lr_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a Pandas series, ranges from a csv, and a linear regression model </span>
<span class="sd">    in order to calculate Refrig_charge for the given row through linear interpolation. </span>
<span class="sd">    Args: </span>
<span class="sd">        row (pd.Series): Pandas series</span>
<span class="sd">        x_range (&lt;class &#39;list&#39;&gt;): List of ints</span>
<span class="sd">        row_range (&lt;class &#39;list&#39;&gt;): List of ints</span>
<span class="sd">        superchart (pd.Dataframe): Pandas dataframe, big grid of ints</span>
<span class="sd">        lr_model (sklearn.linear_model.Fit): Linear regression model</span>
<span class="sd">    Returns: </span>
<span class="sd">        row (pd.Series): Pandas series (Refrig_charge added!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">superheat_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

    <span class="c1">#IF Temp_ODT, Temp_RAT, Humidity_RARH, Pressure_SL_psi, or Temp_SL_C</span>
    <span class="c1"># is null, just return the row early. </span>
    <span class="k">if</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Temp_ODT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Temp_RAT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Humidity_RARH&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Pressure_SL_psi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Temp_SL_C&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="c1">#Convert F to C return air temperature</span>
    <span class="n">RAT_C</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Temp_RAT&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">rh</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Humidity_RARH&quot;</span><span class="p">]</span>

    <span class="c1">#calculate wet bulb temp w/humidity and air temp, then convert back to F</span>
    <span class="n">Temp_wb_C</span> <span class="o">=</span> <span class="n">RAT_C</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="mf">0.151977</span><span class="o">*</span><span class="p">(</span><span class="n">rh</span> <span class="o">+</span> <span class="mf">8.31659</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">RAT_C</span> <span class="o">+</span> <span class="n">rh</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">rh</span> <span class="o">-</span> <span class="mf">1.676331</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.00391838</span><span class="o">*</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="mf">0.023101</span><span class="o">*</span><span class="n">rh</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.686035</span>
    <span class="n">Temp_wb_F</span> <span class="o">=</span> <span class="p">(</span><span class="n">Temp_wb_C</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="mi">32</span>
    <span class="n">Temp_ODT</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Temp_ODT&#39;</span><span class="p">]</span>

    <span class="c1">#NA checks, elif bound check, else interpolations</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Temp_ODT</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Temp_wb_F</span><span class="p">)):</span>
        <span class="c1">#filtering out na&#39;s in recorded data</span>
        <span class="n">superheat_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">Temp_ODT</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">row_range</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Temp_ODT</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">row_range</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Temp_wb_F</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Temp_wb_F</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_range</span><span class="p">)):</span>
        <span class="n">superheat_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#row_range exists so this can have yrange</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Temp_ODT</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Temp_ODT</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">]</span>

        <span class="n">table_v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Temp_wb_F</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">superchart</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_min</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">y_max</span> <span class="o">==</span> <span class="n">y_min</span><span class="p">):</span>
            <span class="n">superheat_target</span> <span class="o">=</span> <span class="n">table_v1</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">table_v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Temp_wb_F</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">superchart</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_max</span><span class="p">])</span>
            <span class="n">xvalue_range3</span> <span class="o">=</span> <span class="p">[</span><span class="n">table_v1</span><span class="p">,</span> <span class="n">table_v2</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xvalue_range3</span><span class="p">))):</span>
                <span class="n">superheat_target</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">superheat_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Temp_ODT</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xvalue_range3</span><span class="p">)</span>

    <span class="c1">#finding superheat_calc</span>
    <span class="n">sat_temp_f</span> <span class="o">=</span> <span class="n">lr_model</span><span class="o">.</span><span class="n">coef_</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Pressure_SL_psi&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">lr_model</span><span class="o">.</span><span class="n">intercept_</span>
    <span class="n">Temp_SL_F</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Temp_SL_C&quot;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span>
    <span class="n">superheat_calc</span> <span class="o">=</span> <span class="n">Temp_SL_F</span> <span class="o">-</span> <span class="n">sat_temp_f</span>

    <span class="c1">#now that we have superheat_calc and superheat_target, we calc</span>
    <span class="c1">#refrigerant charge and add it back to the series.</span>
    <span class="n">r_charge</span> <span class="o">=</span> <span class="n">superheat_calc</span> <span class="o">-</span> <span class="n">superheat_target</span> 
    <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Refrig_charge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_charge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">row</span>

<div class="viewcode-block" id="get_refrig_charge"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.get_refrig_charge">[docs]</a><span class="k">def</span> <span class="nf">get_refrig_charge</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">site_info_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_input_directory</span><span class="si">}</span><span class="s2">site_info.csv&quot;</span><span class="p">,</span> <span class="n">four_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_input_directory</span><span class="si">}</span><span class="s2">410a_pt.csv&quot;</span><span class="p">,</span> <span class="n">superheat_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_input_directory</span><span class="si">}</span><span class="s2">superheat.csv&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a site dataframe, its site name as a string, the path to site_info.csv as a string, </span>
<span class="sd">    the path to superheat.csv as a string, and the path to 410a_pt.csv, and calculates the refrigerant </span>
<span class="sd">    charge per minute? </span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): Pandas Dataframe</span>
<span class="sd">        site (str): site name as a string </span>
<span class="sd">        site_info_path (str): path to site_info.csv as a string</span>
<span class="sd">        four_path (str) path to 410a_pt.csv as a string</span>
<span class="sd">        superheat_path (str): path to superheat.csv as a string</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: modified Pandas Dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="c1">#if DF empty, return the df as is</span>
    <span class="k">if</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">site_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">site_info_directory</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">metering_device</span> <span class="o">=</span> <span class="n">site_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">site</span><span class="p">,</span> <span class="s2">&quot;metering_device&quot;</span><span class="p">]</span>

    <span class="c1">#this specific lr_model is needed for both superheat AND subcooling!</span>
    <span class="n">four_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">four_directory</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">four_df</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">four_df</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">lr_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1">#Creating Refrig_charge column populated w/None</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Refrig_charge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

    <span class="c1"># .apply on every row once the metering device has been determined. different calcs for each!</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metering_device</span> <span class="o">==</span> <span class="s2">&quot;txv&quot;</span><span class="p">):</span>
        <span class="c1">#calculate the refrigerant charge w/the subcooling method</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_subcooling</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lr_model</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">metering_device</span> <span class="o">==</span> <span class="s2">&quot;orifice&quot;</span><span class="p">):</span>
        <span class="c1">#If any crucial vars for calculating refrigerant charge are missing, we return early</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
        <span class="k">if</span> <span class="s2">&quot;Temp_ODT&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_names</span> <span class="ow">or</span> <span class="s2">&quot;Temp_RAT&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_names</span> <span class="ow">or</span> <span class="s2">&quot;Humidity_RARH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_names</span> <span class="ow">or</span> <span class="s2">&quot;Pressure_SL_psi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_names</span> <span class="ow">or</span> <span class="s2">&quot;Temp_SL_C&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># calculate the refrigerant charge w/the superheat method</span>
        <span class="n">superchart</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">superheat_directory</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">superchart</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_range</span><span class="p">]</span> 
        <span class="n">row_range</span> <span class="o">=</span> <span class="n">superchart</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">row_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row_range</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_superheat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">superchart</span><span class="p">,</span> <span class="n">lr_model</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="gather_outdoor_conditions"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.gather_outdoor_conditions">[docs]</a><span class="k">def</span> <span class="nf">gather_outdoor_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a site dataframe and site name as a string. Returns a new dataframe</span>
<span class="sd">    that contains time_utc, &lt;site&gt;_ODT, and &lt;site&gt;_ODRH for the site.</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): Pandas Dataframe</span>
<span class="sd">        site (str): site name as string</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: new Pandas Dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
      <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
      <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
      <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Power_OD_total1&quot;</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">odc_df</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[[</span><span class="s2">&quot;time_utc&quot;</span><span class="p">,</span> <span class="s2">&quot;Temp_ODT&quot;</span><span class="p">,</span> <span class="s2">&quot;Humidity_ODRH&quot;</span><span class="p">,</span> <span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">]]</span>
        <span class="n">odc_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Power_OD_total1&quot;</span><span class="p">:</span> <span class="s2">&quot;Power_OD&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">odc_df</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[[</span><span class="s2">&quot;time_utc&quot;</span><span class="p">,</span> <span class="s2">&quot;Temp_ODT&quot;</span><span class="p">,</span> <span class="s2">&quot;Humidity_ODRH&quot;</span><span class="p">,</span> <span class="s2">&quot;Power_DHP&quot;</span><span class="p">]]</span>
        <span class="n">odc_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Power_DHP&quot;</span><span class="p">:</span> <span class="s2">&quot;Power_OD&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="n">odc_df</span> <span class="o">=</span> <span class="n">odc_df</span><span class="p">[</span><span class="n">odc_df</span><span class="p">[</span><span class="s2">&quot;Power_OD&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">]</span> 
      <span class="n">odc_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Power_OD&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">odc_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Temp_ODT&quot;</span><span class="p">:</span> <span class="n">site</span> <span class="o">+</span> <span class="s2">&quot;_ODT&quot;</span><span class="p">,</span> <span class="s2">&quot;Humidity_ODRH&quot;</span><span class="p">:</span> <span class="n">site</span> <span class="o">+</span> <span class="s2">&quot;_ODRH&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">odc_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>
    

<div class="viewcode-block" id="change_ID_to_HVAC"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.change_ID_to_HVAC">[docs]</a><span class="k">def</span> <span class="nf">change_ID_to_HVAC</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site_info</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a site dataframe along with the name and path of the site and assigns</span>
<span class="sd">    a unique event_ID value whenever the system changes state.</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): Pandas Dataframe</span>
<span class="sd">        site_info (pd.Series):site_info.csv as a pd.Series</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: modified Pandas Dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Power_FURN1&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Power_FURN1&quot;</span><span class="p">:</span> <span class="s2">&quot;Power_AH1&quot;</span><span class="p">})</span>
    <span class="n">statePowerAHThreshold</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="s1">&#39;AH_standby_power&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_AH1&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">statePowerAHThreshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_ID</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)):</span>
        <span class="k">if</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)):</span>
            <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">diff_minutes</span> <span class="o">=</span> <span class="n">time_diff</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="k">if</span><span class="p">(</span><span class="n">diff_minutes</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">event_ID</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;event_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">event_ID</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;event_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_ID</span>
    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1"># TODO: update this function from using a passed in date to using date from last row</span>
<div class="viewcode-block" id="nclarity_filter"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.nclarity_filter">[docs]</a><span class="k">def</span> <span class="nf">nclarity_filter</span><span class="p">(</span><span class="n">date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function filters the filenames list to only those from the given date.</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        date (str): target date</span>
<span class="sd">        filenames (List[str]): List of filenames to be filtered</span>
<span class="sd">    Returns: </span>
<span class="sd">        List[str]: Filtered list of filenames</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">filename</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">18</span><span class="p">:</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">date</span><span class="p">,</span> <span class="n">filenames</span><span class="p">))</span></div>


<div class="viewcode-block" id="nclarity_csv_to_df"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.nclarity_csv_to_df">[docs]</a><span class="k">def</span> <span class="nf">nclarity_csv_to_df</span><span class="p">(</span><span class="n">csv_filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes a list of csv filenames containing nclarity data and reads all files into a singular dataframe.</span>
<span class="sd">    Args: </span>
<span class="sd">        csv_filenames (List[str]): List of filenames </span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: Pandas Dataframe containing data from all files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">csv_filenames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File Not Found: &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_add_date</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">temp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">temp_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="aqsuite_prep_time"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.aqsuite_prep_time">[docs]</a><span class="k">def</span> <span class="nf">aqsuite_prep_time</span><span class="p">(</span><span class="n">df</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes an aqsuite dataframe and converts the time column into datetime type</span>
<span class="sd">    and sorts the entire dataframe by time.</span>
<span class="sd">    Prereq: </span>
<span class="sd">        Input dataframe MUST be an aqsuite Dataframe whose columns have not yet been renamed</span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): Aqsuite DataFrame</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: Pandas Dataframe containing data from all files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time(UTC)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time(UTC)&#39;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;time(UTC)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="aqsuite_filter_new"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.aqsuite_filter_new">[docs]</a><span class="k">def</span> <span class="nf">aqsuite_filter_new</span><span class="p">(</span><span class="n">last_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prev_opened</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_input_directory</span><span class="si">}</span><span class="s1">previous.pkl&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function filters the filenames list to only those newer than the last date.</span>
<span class="sd">    Args: </span>
<span class="sd">        last_date (str): latest date loaded prior to current runtime</span>
<span class="sd">        filenames (List[str]): List of filenames to be filtered</span>
<span class="sd">        site (str): site name</span>
<span class="sd">        prev_opened (str): pkl directory for previously opened files</span>
<span class="sd">    Returns: </span>
<span class="sd">        List[str]: Filtered list of filenames</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Opens the df that contains the dictionary of what each file is</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prev_opened</span><span class="p">):</span>
        <span class="c1"># Columns are site, filename, start datetime, end datetime</span>
        <span class="n">prev_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">prev_opened</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prev_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;start_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;end_datetime&#39;</span><span class="p">])</span>
        <span class="n">prev_df</span><span class="p">[[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;end_datetime&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prev_df</span><span class="p">[[</span>
            <span class="s1">&#39;start_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;end_datetime&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">)</span>

    <span class="c1"># Filter files by what has not been opened</span>
    <span class="n">prev_filename_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prev_df</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
    <span class="n">new_filenames</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prev_filename_set</span><span class="p">]</span>

    <span class="c1"># Add files to prev_df</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">new_filenames</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time(UTC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;time(UTC)&quot;</span><span class="p">])</span>
        <span class="n">max_date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time(UTC)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">min_date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time(UTC)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">new_entry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">site</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                     <span class="s1">&#39;start_datetime&#39;</span><span class="p">:</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;end_datetime&#39;</span><span class="p">:</span> <span class="n">max_date</span><span class="p">}</span>
        <span class="n">prev_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">prev_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">new_entry</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save new prev_df</span>
    <span class="n">prev_df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">prev_opened</span><span class="p">)</span>

    <span class="c1"># List all files with the date equal or newer than last_date</span>
    <span class="n">last_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">last_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">filtered_prev_df</span> <span class="o">=</span> <span class="n">prev_df</span><span class="p">[([</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">prev_df</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">last_date</span><span class="p">)]</span>
    <span class="n">filtered_filenames</span> <span class="o">=</span> <span class="n">filtered_prev_df</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">filtered_filenames</span></div>



<span class="k">def</span> <span class="nf">_add_date</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LBNL&#39;s nclarity files do not contain the date in the time column. This</span>
<span class="sd">    helper function extracts the date from the filename and adds it to the </span>
<span class="sd">    time column of the data.</span>
<span class="sd">    Args: </span>
<span class="sd">        df (pd.DataFrame): Dataframe</span>
<span class="sd">        filename (str): filename as string</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Modified dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">18</span><span class="p">:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">date</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span>


<div class="viewcode-block" id="add_local_time"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.add_local_time">[docs]</a><span class="k">def</span> <span class="nf">add_local_time</span><span class="p">(</span><span class="n">df</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site_name</span> <span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function adds a column to the dataframe with the local time.</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): Dataframe</span>
<span class="sd">        site_name (str): site name </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_dir</span> <span class="o">=</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">)</span>
    <span class="n">site_info_path</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">+</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;site_info&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">site_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">site_info_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File Not Found: &quot;</span><span class="p">,</span> <span class="n">site_info_path</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">site_info_df</span> <span class="o">=</span> <span class="n">site_info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">site_info_df</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">site_info_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">local_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">site_info_df</span><span class="p">[</span><span class="s1">&#39;local_tz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time_local&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_utc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">local_tz</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="elev_correction"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.elev_correction">[docs]</a><span class="k">def</span> <span class="nf">elev_correction</span><span class="p">(</span><span class="n">site_name</span> <span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function creates a dataframe for a given site that contains site name, elevation, </span>
<span class="sd">    and the corrected elevation.</span>
<span class="sd">    Args: </span>
<span class="sd">        site_name (str): site&#39;s name</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: new Pandas dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_dir</span> <span class="o">=</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">)</span>
    <span class="n">site_info_path</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">+</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;site_info&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">site_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">site_info_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File Not Found: &quot;</span><span class="p">,</span> <span class="n">site_info_path</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">site_info_df</span> <span class="o">=</span> <span class="n">site_info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">site_info_df</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site_name</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">site_info_df</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">site_info_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="s1">&#39;elev&#39;</span> <span class="ow">in</span> <span class="n">site_info_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">elev_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">3000</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="mi">5000</span><span class="p">,</span><span class="mi">6000</span><span class="p">,</span><span class="mi">7000</span><span class="p">,</span><span class="mi">8000</span><span class="p">,</span><span class="mi">9000</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="mi">11000</span><span class="p">,</span><span class="mi">12000</span><span class="p">])</span>
        <span class="n">elev_ft</span> <span class="o">=</span> <span class="n">elev_ft</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">alt_corr_fact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.97</span><span class="p">,</span><span class="mf">0.93</span><span class="p">,</span><span class="mf">0.89</span><span class="p">,</span><span class="mf">0.87</span><span class="p">,</span><span class="mf">0.84</span><span class="p">,</span><span class="mf">0.80</span><span class="p">,</span><span class="mf">0.77</span><span class="p">,</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">0.72</span><span class="p">,</span><span class="mf">0.69</span><span class="p">,</span><span class="mf">0.66</span><span class="p">,</span><span class="mf">0.63</span><span class="p">])</span>

        <span class="n">lin_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">elev_ft</span><span class="p">,</span> <span class="n">alt_corr_fact</span><span class="p">)</span>
        <span class="n">elv_df</span> <span class="o">=</span> <span class="n">site_info_df</span><span class="p">[[</span><span class="s1">&#39;elev&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">air_corr</span> <span class="o">=</span> <span class="n">lin_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">elv_df</span><span class="p">)</span>

        <span class="n">site_air_corr</span> <span class="o">=</span> <span class="n">site_info_df</span><span class="p">[[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span><span class="s1">&#39;elev&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">site_air_corr</span> <span class="o">=</span> <span class="n">site_air_corr</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">air_corr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">site_air_corr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">site_air_corr</span><span class="p">[</span><span class="s2">&quot;elev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">site_air_corr</span><span class="p">[</span><span class="s2">&quot;elev&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">),</span> <span class="s2">&quot;air_corr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">air_corr</span>
      
        <span class="k">return</span> <span class="n">site_air_corr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span></div>


<div class="viewcode-block" id="replace_humidity"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.replace_humidity">[docs]</a><span class="k">def</span> <span class="nf">replace_humidity</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">od_conditions</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">date_forward</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">site_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function replaces all humidity readings for a given site after a given datetime. </span>
<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): Dataframe containing the raw sensor data.</span>
<span class="sd">        od_conditions (pd.DataFrame): DataFrame containing outdoor confitions measured by field sensors.</span>
<span class="sd">        date_forward (dt.datetime): Datetime containing the time after which all humidity readings should be replaced.</span>
<span class="sd">        site_name (str): String containing the name of the site for which humidity values are to be replaced.</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Modified DataFrame where the Humidity_ODRH column contains the field readings after the given datetime. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">od_conditions</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">date_forward</span><span class="p">,</span> <span class="s2">&quot;Humidity_ODRH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">data_old</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Humidity_ODRH&quot;</span><span class="p">]</span>

        <span class="n">data_new</span> <span class="o">=</span> <span class="n">od_conditions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">od_conditions</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">date_forward</span><span class="p">]</span>
        <span class="n">data_new</span> <span class="o">=</span> <span class="n">data_new</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2">_ODRH&quot;</span><span class="p">]</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Humidity_ODRH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_old</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">data_new</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="create_fan_curves"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.create_fan_curves">[docs]</a><span class="k">def</span> <span class="nf">create_fan_curves</span><span class="p">(</span><span class="n">cfm_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create fan curves for each site.</span>
<span class="sd">    Args:</span>
<span class="sd">        cfm_info (pd.DataFrame): DataFrame of fan curve information.</span>
<span class="sd">        site_info (pd.Series): Series containing the site information.</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Dataframe containing the fan curves for each site.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert furnace power from kW to W</span>
    <span class="n">site_info</span><span class="p">[</span><span class="s1">&#39;furn_misc_power&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1000</span>

    <span class="c1"># Calculate furnace power to remove from blower power</span>
    <span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="s1">&#39;furn_misc_power&#39;</span><span class="p">]</span>
    <span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;heat&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Subtract furnace power from blower power</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cfm_info</span><span class="p">[</span><span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">cfm_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;ID_blower_rms_watts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfm_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span>
                                                             <span class="s1">&#39;ID_blower_rms_watts&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cfm_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;watts_to_remove&#39;</span><span class="p">]</span>
    <span class="c1">#cfm_info.loc[mask, &#39;ID_blower_rms_watts&#39;] -= cfm_info[&#39;watts_to_remove&#39;]</span>

    <span class="c1"># Group by site and estimate coefficients</span>
    <span class="n">by_site</span> <span class="o">=</span> <span class="n">cfm_info</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">estimate_coefficients</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate coefficients for the fan curve.</span>
<span class="sd">        Args:</span>
<span class="sd">            group (pd.DataFrame): Dataframe containing the data for a given site.</span>
<span class="sd">        Returns:</span>
<span class="sd">            pd.Series: Series containing the coefficients for the fan curve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">group</span><span class="p">[[</span><span class="s1">&#39;ID_blower_rms_watts&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">**</span> <span class="mf">0.3333</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;ID_blower_cfm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># For the linear regression model generated below, return the a and b coefficients</span>
        <span class="n">fan_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fan_model</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">fan_model</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">coefficients</span>
    <span class="n">fan_coeffs</span> <span class="o">=</span> <span class="n">by_site</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">estimate_coefficients</span><span class="p">)</span>
    <span class="n">fan_coeffs</span> <span class="o">=</span> <span class="n">fan_coeffs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fan_coeffs</span></div>


<div class="viewcode-block" id="get_cfm_values"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.get_cfm_values">[docs]</a><span class="k">def</span> <span class="nf">get_cfm_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">site_cfm</span><span class="p">,</span> <span class="n">site_info</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
    <span class="n">site_cfm</span> <span class="o">=</span> <span class="n">site_cfm</span><span class="p">[</span><span class="n">site_cfm</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span>
    <span class="n">fan_curve</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">site_cfm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;use_fan_curve&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fan_curve</span><span class="p">:</span>
        <span class="n">cfm_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">cfm_info</span><span class="p">[</span><span class="s2">&quot;circ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_cfm</span><span class="p">[</span><span class="s2">&quot;ID_blower_cfm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">site_cfm</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*circ.*&quot;</span><span class="p">,</span> <span class="n">site_cfm</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
        <span class="n">cfm_info</span><span class="p">[</span><span class="s2">&quot;heat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_cfm</span><span class="p">[</span><span class="s2">&quot;ID_blower_cfm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">site_cfm</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*heat.*&quot;</span><span class="p">,</span> <span class="n">site_cfm</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
        <span class="n">cfm_info</span><span class="p">[</span><span class="s2">&quot;cool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_cfm</span><span class="p">[</span><span class="s2">&quot;ID_blower_cfm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">site_cfm</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*cool.*&quot;</span><span class="p">,</span> <span class="n">site_cfm</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Cfm_Calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cfm_info</span><span class="p">[</span><span class="n">state</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfm_info</span><span class="p">[</span><span class="n">state</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;HVAC&quot;</span><span class="p">]]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">heat_in_HVAC</span> <span class="o">=</span> <span class="s2">&quot;heat&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;HVAC&quot;</span><span class="p">])</span>

        <span class="n">cfm_temp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_AH1&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">heat_in_HVAC</span><span class="p">:</span>
            <span class="n">furn_misc_power</span> <span class="o">=</span> <span class="n">site_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">site</span><span class="p">,</span> <span class="s2">&quot;furn_misc_power&quot;</span><span class="p">]</span>
            <span class="n">furn_misc_power</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">furn_misc_power</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">else</span> <span class="n">furn_misc_power</span>
            <span class="n">cfm_temp</span> <span class="o">=</span> <span class="n">cfm_temp</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_AH1&quot;</span><span class="p">]),</span> <span class="n">furn_misc_power</span><span class="p">)</span>

        <span class="n">cfm_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfm_temp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Cfm_Calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfm_temp</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_acf"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.get_acf">[docs]</a><span class="k">def</span> <span class="nf">get_acf</span><span class="p">(</span><span class="n">elev</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">elev</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">elev</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># create arrays for elevation in feet and altitude correction factor</span>
    <span class="n">elev_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">7000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">])</span>
    <span class="n">acf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="mf">0.89</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.69</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">])</span>
    <span class="n">cf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;elev_ft&#39;</span><span class="p">:</span> <span class="n">elev_ft</span><span class="p">,</span> <span class="s1">&#39;acf&#39;</span><span class="p">:</span> <span class="n">acf</span><span class="p">})</span>
    <span class="n">dens_cor_reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cf_df</span><span class="p">[[</span><span class="s1">&#39;elev_ft&#39;</span><span class="p">]],</span> <span class="n">cf_df</span><span class="p">[</span><span class="s1">&#39;acf&#39;</span><span class="p">])</span>

    <span class="c1"># use the linear regression model to predict the air correction factor for each site</span>
    <span class="n">site_elevation</span> <span class="o">=</span> <span class="n">elev</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">air_corr</span> <span class="o">=</span> <span class="n">dens_cor_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">site_elevation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">air_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_cop_values"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.get_cop_values">[docs]</a><span class="k">def</span> <span class="nf">get_cop_values</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">site_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="n">w_to_btuh</span> <span class="o">=</span> <span class="mf">3.412</span>
    <span class="n">btuh_to_w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">w_to_btuh</span>
    <span class="n">air_density</span> <span class="o">=</span> <span class="mf">1.08</span>
    <span class="n">air_correction_factor</span> <span class="o">=</span> <span class="n">get_acf</span><span class="p">(</span><span class="n">site_info</span><span class="p">[</span><span class="s2">&quot;elev&quot;</span><span class="p">])</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_Output_BTUh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_SAT1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Temp_RAT&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Cfm_Calc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">air_density</span> <span class="o">*</span> <span class="n">air_correction_factor</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;HVAC&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;heat&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;HVAC&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;circ&quot;</span><span class="p">),</span> <span class="s2">&quot;Power_Output_BTUh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_Output_kW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_Output_BTUh&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">btuh_to_w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_Output_kW&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Power_system1&quot;</span><span class="p">])</span> 
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;cop&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;cop&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()),</span> <span class="s2">&quot;cop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;Power_Output_BTUh&quot;</span><span class="p">,</span> <span class="s2">&quot;Power_Output_kW&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_site_info"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.get_site_info">[docs]</a><span class="k">def</span> <span class="nf">get_site_info</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dataframe of the site information for the given site</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        site (str): The site name</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        df (pd.Series): The Series of the site information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">site_info_path</span> <span class="o">=</span> <span class="n">_input_directory</span> <span class="o">+</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;site_info&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">site_info_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_site_cfm_info"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.get_site_cfm_info">[docs]</a><span class="k">def</span> <span class="nf">get_site_cfm_info</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dataframe of the site cfm information for the given site</span>
<span class="sd">    NOTE: The parsing is necessary as the first row of data are comments that need to be dropped.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        site (str): The site name</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        df (pd.DataFrame): The DataFrame of the site cfm information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">site_cfm_info_path</span> <span class="o">=</span> <span class="n">_input_directory</span> <span class="o">+</span> <span class="n">configure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;site_cfm_info&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">site_cfm_info_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">encoding_errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="merge_indexlike_rows"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.lbnl.merge_indexlike_rows">[docs]</a><span class="k">def</span> <span class="nf">merge_indexlike_rows</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges index-like rows together ensuring that all relevant information for a</span>
<span class="sd">    certain timestamp is stored in one row - not in multiple rows. It also rounds the</span>
<span class="sd">    timestamps to the nearest minute.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path (str): The file path to the data.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        df (pd.DataFrame): The DataFrame with all index-like rows merged. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time_utc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time_utc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;time_utc&quot;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time_utc&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

    <span class="n">to_del</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;time_utc&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;time_utc&quot;</span><span class="p">]:</span>
            <span class="n">data_combined</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">else</span> <span class="n">y</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
            <span class="n">data_combined</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;time_utc&quot;</span><span class="p">])</span>

            <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_combined</span>
            <span class="n">to_del</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">to_del</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;time_utc&quot;</span><span class="p">])</span>

    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ecotope Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>