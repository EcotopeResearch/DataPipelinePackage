<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ecopipeline.extract &mdash; Ecotope Datapipeline (Ecopipeline) 0.0.13 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Ecotope Datapipeline (Ecopipeline)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ecotope Datapipeline (Ecopipeline)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ecopipeline.extract</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ecopipeline.extract</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">ftplib</span> <span class="kn">import</span> <span class="n">FTP</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">ecopipeline.unit_convert</span> <span class="kn">import</span> <span class="n">temp_c_to_f</span><span class="p">,</span> <span class="n">divide_num_by_ten</span><span class="p">,</span> <span class="n">windspeed_mps_to_knots</span><span class="p">,</span> <span class="n">precip_cm_to_mm</span><span class="p">,</span> <span class="n">conditions_index_to_desc</span>
<span class="kn">from</span> <span class="nn">ecopipeline.load</span> <span class="kn">import</span> <span class="n">connect_db</span><span class="p">,</span> <span class="n">get_login_info</span>
<span class="kn">from</span> <span class="nn">ecopipeline.config</span> <span class="kn">import</span> <span class="n">_config_directory</span><span class="p">,</span> <span class="n">_data_directory</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">mysql.connector.errors</span> <span class="k">as</span> <span class="nn">mysqlerrors</span>


<div class="viewcode-block" id="get_last_full_day_from_db"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.get_last_full_day_from_db">[docs]</a><span class="k">def</span> <span class="nf">get_last_full_day_from_db</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_config_directory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function retrieves the last line from the database with the most recent datetime.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_file_path (str): Path to config file (default is set in load.py) TODO this is not used lol</span>
<span class="sd">    Returns: </span>
<span class="sd">        datetime: end of last full day populated in database or default past time if no data found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">get_login_info</span><span class="p">([</span><span class="s2">&quot;minute&quot;</span><span class="p">])</span>
    <span class="n">db_connection</span><span class="p">,</span> <span class="n">db_cursor</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">(</span><span class="n">config_info</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">])</span>
    <span class="n">return_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">))</span> <span class="c1"># arbitrary default time</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select * from </span><span class="si">{</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">][</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> order by time_pt DESC LIMIT 1&quot;</span><span class="p">)</span>

        <span class="n">last_row_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_row_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_time</span> <span class="o">=</span> <span class="n">last_row_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get time from last_data_row[0][0] TODO probably better way to do this</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">last_time</span><span class="o">.</span><span class="n">hour</span> <span class="o">!=</span> <span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">last_time</span><span class="o">.</span><span class="n">minute</span> <span class="o">!=</span> <span class="mi">59</span><span class="p">)):</span>
                <span class="n">pacific_tz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">)</span>
                <span class="n">return_time</span> <span class="o">=</span> <span class="n">last_time</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">return_time</span> <span class="o">=</span> <span class="n">return_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">return_time</span> <span class="o">=</span> <span class="n">last_time</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database has no previous data. Using default time to extract data.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">mysqlerrors</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to find last timestamp in database. Using default time to extract data.&quot;</span><span class="p">)</span>

    <span class="n">db_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">return_time</span></div>

<div class="viewcode-block" id="get_db_row_from_time"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.get_db_row_from_time">[docs]</a><span class="k">def</span> <span class="nf">get_db_row_from_time</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts a row from the applicable minute table in the database for the given datetime or returns empty dataframe if none exists</span>

<span class="sd">    Args:</span>
<span class="sd">        time (datetime): The time index to get the row from</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: Pandas Dataframe containing the row or empty if no row exists for the timestamp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">get_login_info</span><span class="p">([</span><span class="s2">&quot;minute&quot;</span><span class="p">])</span>
    <span class="n">db_connection</span><span class="p">,</span> <span class="n">db_cursor</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">(</span><span class="n">config_info</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">])</span>
    <span class="n">row_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">][</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> WHERE time_pt = &#39;</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">db_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">db_cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
            <span class="n">row_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">row</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">mysqlerrors</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error executing sql query.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MySQL error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">db_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">row_data</span></div>



<div class="viewcode-block" id="extract_new"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.extract_new">[docs]</a><span class="k">def</span> <span class="nf">extract_new</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">json_filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function filters the filenames to only those newer than the last date.</span>

<span class="sd">    Args: </span>
<span class="sd">        time (datetime): The point in time for which we want to start the data extraction from</span>
<span class="sd">        json_filenames (List[str]): List of filenames to be filtered</span>
<span class="sd">    Returns: </span>
<span class="sd">        List[str]: Filtered list of filenames</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">))</span>
    <span class="n">return_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">17</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">time_int</span><span class="p">,</span> <span class="n">json_filenames</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">return_list</span></div>


<div class="viewcode-block" id="extract_files"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.extract_files">[docs]</a><span class="k">def</span> <span class="nf">extract_files</span><span class="p">(</span><span class="n">extension</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a file extension and subdirectory and returns a list of paths files in the directory of that type.</span>

<span class="sd">    Args: </span>
<span class="sd">        extension (str): File extension as string</span>
<span class="sd">        subdir (str): subdirectory (defaults to no subdir)</span>
<span class="sd">    Returns: </span>
<span class="sd">        List[str]: List of filenames </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_data_directory</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extension</span><span class="p">):</span>
            <span class="n">full_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_data_directory</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filenames</span></div>


<div class="viewcode-block" id="json_to_df"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.json_to_df">[docs]</a><span class="k">def</span> <span class="nf">json_to_df</span><span class="p">(</span><span class="n">json_filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes a list of gz/json filenames and reads all files into a singular dataframe.</span>

<span class="sd">    Args: </span>
<span class="sd">        json_filenames (List[str]): List of filenames </span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: Pandas Dataframe containing data from all files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">json_filenames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File Not Found: &quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Empty or invalid JSON File&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: This section is BV specific, maybe move to another function</span>
        <span class="n">norm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">record_path</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sensors&#39;</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">norm_data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
            <span class="n">norm_data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">)</span>
            <span class="n">norm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="n">temp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">temp_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="csv_to_df"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.csv_to_df">[docs]</a><span class="k">def</span> <span class="nf">csv_to_df</span><span class="p">(</span><span class="n">csv_filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes a list of csv filenames and reads all files into a singular dataframe.</span>

<span class="sd">    Args: </span>
<span class="sd">        csv_filenames (List[str]): List of filenames </span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: Pandas Dataframe containing data from all files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">csv_filenames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File Not Found: &quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">temp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">temp_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_sub_dirs"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.get_sub_dirs">[docs]</a><span class="k">def</span> <span class="nf">get_sub_dirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function takes in a directory and returns a list of the paths to all immediate subfolders in that directory.</span>

<span class="sd">    Args: </span>
<span class="sd">        dir (str): Directory as a string.</span>
<span class="sd">    Returns: </span>
<span class="sd">        List[str]: List of paths to subfolders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">directories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folder not Found: &quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">directories</span></div>


<div class="viewcode-block" id="get_noaa_data"><a class="viewcode-back" href="../../ecopipeline.html#ecopipeline.extract.get_noaa_data">[docs]</a><span class="k">def</span> <span class="nf">get_noaa_data</span><span class="p">(</span><span class="n">station_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function will take in a list of station names and will return a dictionary where the key is the station name and the value is a dataframe with the parsed weather data.</span>

<span class="sd">    Args: </span>
<span class="sd">        station_names (List[str]): List of Station Names</span>
<span class="sd">    Returns: </span>
<span class="sd">        dict: Dictionary with key as Station Name and Value as DF of Parsed Weather Data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">noaa_dictionary</span> <span class="o">=</span> <span class="n">_get_noaa_dictionary</span><span class="p">()</span>
    <span class="n">station_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">noaa_dictionary</span><span class="p">[</span><span class="n">station_name</span><span class="p">]</span>
        <span class="p">:</span> <span class="n">station_name</span> <span class="k">for</span> <span class="n">station_name</span> <span class="ow">in</span> <span class="n">station_names</span> <span class="k">if</span> <span class="n">station_name</span> <span class="ow">in</span> <span class="n">noaa_dictionary</span><span class="p">}</span>
    <span class="n">noaa_filenames</span> <span class="o">=</span> <span class="n">_download_noaa_data</span><span class="p">(</span><span class="n">station_ids</span><span class="p">)</span>
    <span class="n">noaa_dfs</span> <span class="o">=</span> <span class="n">_convert_to_df</span><span class="p">(</span><span class="n">station_ids</span><span class="p">,</span> <span class="n">noaa_filenames</span><span class="p">)</span>
    <span class="n">formatted_dfs</span> <span class="o">=</span> <span class="n">_format_df</span><span class="p">(</span><span class="n">station_ids</span><span class="p">,</span> <span class="n">noaa_dfs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">formatted_dfs</span></div>


<span class="k">def</span> <span class="nf">_format_df</span><span class="p">(</span><span class="n">station_ids</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">noaa_dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function will take a list of station ids and a dictionary of filename and the respective file stored in a dataframe. </span>
<span class="sd">    The function will return a dictionary where the key is the station id and the value is a dataframe for that station.</span>

<span class="sd">    Args: </span>
<span class="sd">        station_ids (dict): Dictionary of station_ids,</span>
<span class="sd">        noaa_dfs (dict): dictionary of filename and the respective file stored in a dataframe</span>
<span class="sd">    Returns: </span>
<span class="sd">        dict: Dictionary where the key is the station id and the value is a dataframe for that station</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formatted_dfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">value1</span> <span class="ow">in</span> <span class="n">station_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Append all DataFrames with the same station_id</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;airTemp&#39;</span><span class="p">,</span> <span class="s1">&#39;dewPoint&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;seaLevelPressure&#39;</span><span class="p">,</span> <span class="s1">&#39;windDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;windSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;conditions&#39;</span><span class="p">,</span> <span class="s1">&#39;precip1Hour&#39;</span><span class="p">,</span> <span class="s1">&#39;precip6Hour&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">noaa_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">value1</span><span class="p">):</span>
                <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">value</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Do unit Conversions</span>
        <span class="c1"># Convert all -9999 into N/A</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>

        <span class="c1"># Convert tz from UTC to PT and format: Y-M-D HR:00:00</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">temp_df</span><span class="p">[[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">]])</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">)</span>

        <span class="c1"># Convert airtemp, dewpoint, sealevelpressure, windspeed</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;airTemp_F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;airTemp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">temp_c_to_f</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;dewPoint_F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;dewPoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">temp_c_to_f</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;seaLevelPressure_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;seaLevelPressure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">divide_num_by_ten</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;windSpeed_kts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;windSpeed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">windspeed_mps_to_knots</span><span class="p">)</span>

        <span class="c1"># Convert precip</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;precip1Hour_mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;precip1Hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">precip_cm_to_mm</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;precip6Hour_mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;precip6Hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">precip_cm_to_mm</span><span class="p">)</span>

        <span class="c1"># Match case conditions</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">conditions_index_to_desc</span><span class="p">)</span>

        <span class="c1"># Rename windDirections</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;windDirection_deg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;windDirection&quot;</span><span class="p">]</span>

        <span class="c1"># Drop columns that were replaced</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;airTemp&quot;</span><span class="p">,</span> <span class="s2">&quot;dewPoint&quot;</span><span class="p">,</span> <span class="s2">&quot;seaLevelPressure&quot;</span><span class="p">,</span> <span class="s2">&quot;windSpeed&quot;</span><span class="p">,</span> <span class="s2">&quot;precip1Hour&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;precip6Hour&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="s2">&quot;windDirection&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">temp_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Save df in dict</span>
        <span class="n">formatted_dfs</span><span class="p">[</span><span class="n">station_ids</span><span class="p">[</span><span class="n">value1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">temp_df</span>

    <span class="k">return</span> <span class="n">formatted_dfs</span>


<span class="k">def</span> <span class="nf">_get_noaa_dictionary</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function downloads a dictionary of equivalent station id for each station name</span>

<span class="sd">    Args: </span>
<span class="sd">        None</span>
<span class="sd">    Returns: </span>
<span class="sd">        dict: Dictionary of station id and corrosponding station name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather&quot;</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;isd-history.csv&quot;</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ftp.ncdc.noaa.gov&quot;</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/pub/data/noaa/&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ftp_server</span> <span class="o">=</span> <span class="n">FTP</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">ftp_server</span><span class="o">.</span><span class="n">retrbinary</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RETR </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FTP ERROR&quot;</span><span class="p">)</span>

    <span class="n">isd_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather/isd-history.csv&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">isd_directory</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;File path &#39;</span><span class="si">{</span><span class="n">isd_directory</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">isd_history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">isd_directory</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">isd_history</span><span class="p">[</span><span class="s2">&quot;USAF_WBAN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isd_history</span><span class="p">[</span><span class="s1">&#39;USAF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="n">isd_history</span><span class="p">[</span><span class="s1">&#39;WBAN&#39;</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">df_id_usafwban</span> <span class="o">=</span> <span class="n">isd_history</span><span class="p">[[</span><span class="s2">&quot;ICAO&quot;</span><span class="p">,</span> <span class="s2">&quot;USAF_WBAN&quot;</span><span class="p">]]</span>
    <span class="n">df_id_usafwban</span> <span class="o">=</span> <span class="n">df_id_usafwban</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
        <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ICAO&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">noaa_dict</span> <span class="o">=</span> <span class="n">df_id_usafwban</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ICAO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s1">&#39;USAF_WBAN&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">noaa_dict</span>


<span class="k">def</span> <span class="nf">_download_noaa_data</span><span class="p">(</span><span class="n">stations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes in a list of the stations and downloads the corrosponding NOAA weather data via FTP and returns it in a List of filenames</span>

<span class="sd">    Args: </span>
<span class="sd">        stations (dict): dictionary of station_ids who&#39;s data needs to be downloaded</span>
<span class="sd">    Returns: </span>
<span class="sd">        List[str]: List of filenames that were downloaded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">noaa_filenames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">year_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ftp.ncdc.noaa.gov&quot;</span>
        <span class="n">ftp_server</span> <span class="o">=</span> <span class="n">FTP</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FTP ERROR&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># Download files for each station from 2010 till present year</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Set FTP credentials and connect</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/pub/data/noaa/isd-lite/</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="n">ftp_server</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>
        <span class="c1"># Download all files and save as station_year.gz in /data/weather</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather/</span><span class="si">{</span><span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather/</span><span class="si">{</span><span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.gz&quot;</span>
            <span class="n">noaa_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather/</span><span class="si">{</span><span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># Do not download if the file already exists</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_end</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">ftp_server</span><span class="o">.</span><span class="n">retrbinary</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RETR </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot; exists&quot;</span><span class="p">)</span>
    <span class="n">ftp_server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">noaa_filenames</span>


<span class="k">def</span> <span class="nf">_convert_to_df</span><span class="p">(</span><span class="n">stations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">noaa_filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the list of downloaded filenames and imports the files and converts it to a dictionary of DataFrames</span>

<span class="sd">    Args: </span>
<span class="sd">        stations (dict): Dict of stations </span>
<span class="sd">        noaa_filenames (List[str]): List of downloaded filenames</span>
<span class="sd">    Returns: </span>
<span class="sd">        dict: Dictionary where key is filename and value is dataframe for the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">noaa_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">noaa_filenames</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">_gz_to_df</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_data_directory</span><span class="si">}</span><span class="s2">weather/</span><span class="si">{</span><span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;airTemp&#39;</span><span class="p">,</span> <span class="s1">&#39;dewPoint&#39;</span><span class="p">,</span> <span class="s1">&#39;seaLevelPressure&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;windDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;windSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;conditions&#39;</span><span class="p">,</span> <span class="s1">&#39;precip1Hour&#39;</span><span class="p">,</span> <span class="s1">&#39;precip6Hour&#39;</span><span class="p">]</span>
            <span class="n">noaa_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    <span class="n">noaa_dfs_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">noaa_filenames</span><span class="p">,</span> <span class="n">noaa_dfs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">noaa_dfs_dict</span>


<span class="k">def</span> <span class="nf">_gz_to_df</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Opens the file and returns it as a pd.DataFrame</span>

<span class="sd">    Args: </span>
<span class="sd">        filename (str): String of filename to be converted</span>
<span class="sd">    Returns: </span>
<span class="sd">        pd.DataFrame: DataFrame of the corrosponding file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ecotope Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>